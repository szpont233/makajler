<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>Imperium Lechitów - Forum</title>

<link rel="stylesheet" href="../../assets/css/style.css">

<link rel="icon" type="image/png" href="../../assets/favicon-96x96.png" sizes="96x96" />
<link rel="icon" type="image/svg+xml" href="../../assets/favicon.svg" />
<link rel="shortcut icon" href="../../assets/favicon.ico" />
<link rel="apple-touch-icon" sizes="180x180" href="../../assets/apple-touch-icon.png" />
<link rel="manifest" href="../../assets/site.webmanifest" />
<meta name="theme-color" content="#fafafa" />
<link rel="mask-icon" href="../../assets/safari-pinned-tab.svg" color="#c0392b" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">


<style>
#form {
  background-color: #f0f4f8;
  border: 1px solid #999;
  padding: 20px;
  border-radius: 5px;
  width: 100%;
  max-width: 500px;
  margin: 20px auto;
  box-shadow: 0 0 10px rgba(0,0,0,0.1);
}

.field {
  margin-bottom: 15px;
}

.field label {
  display: block;
  font-size: 13px;
  font-weight: bold;
  color: #2b4a80;
  margin-bottom: 5px;
  font-family: Verdana, sans-serif;
}

.field input[type="text"],
.field textarea {
  width: 100%;
  padding: 8px;
  border: 1px solid #ccc;
  border-radius: 3px;
  font-family: Verdana, sans-serif;
  font-size: 13px;
  background-color: #fff;
  box-sizing: border-box;
}

.field textarea {
  min-height: 100px;
  resize: vertical;
}

input[type="submit"] {
  padding: 8px 16px;
  font-size: 14px;
  background-color: #2b4a80;
  color: white;
  border: 1px solid #1c3057;
  border-radius: 3px;
  cursor: pointer;
  font-weight: bold;
  font-family: Verdana, sans-serif;
  transition: background-color 0.2s ease-in-out;
}

input[type="submit"]:hover {
  background-color: #385d8a;
}
#content{
  background-color: #fafafa;
}

    #profreg{
        display: flex;
        justify-content: space-between;
        font-size: 11px;
    }
    #profil{
        padding-right: 15px;
    }
    #register{
        padding-left: 10px;
    }
.entry img {
    max-width: 300px;
    max-height: 200px;
    width: auto;
    height: auto;
    display: block;
    margin: 5px 0;
}
#submit-btn:disabled {
    background: #ccc;
    cursor: not-allowed;
}

#content{ 
    background-color: #fafafa;
    flex: 1; 
    }
#submit-btn:disabled{
     background: #ccc; 
     cursor: not-allowed; 
    }
    
#main{
    display: flex;
    align-items: flex-start;
    gap: 20px;
    padding: 15px; 
    }
#sidebar{ 
    width: 240px;
    flex-shrink: 0;
    }
    
@media(max-width: 900px) {
    #main { flex-direction: column; }
    #sidebar { width: 100%; }
}
</style>
</head>
<body>
<audio src="../../assets/witaj.mp3" hidden autoplay></audio> <!-- dzwiek wiadomosci z gadu gadu przy otwarciu strony-->
<script>
    document.addEventListener('click', function() {
    const audio = new Audio('../../assets/witaj.mp3');
    audio.play();
}, { once: true });
</script>

<div id="header">
    <a href="../../index.html" style="margin: auto; padding: 5px;"><div style="border: 1px solid black; padding: 5px; background-color: #c0c0c0;" ><img src="../../logo.png" alt="logo Lechii" ></div></a>
    <h1>Księga wpisów</h1>
    <p style="text-shadow: 2px 2px 3px black; color: black;">Napisz coś na tablice, i tak bedzie</p>
</div>

<div id="container">
    <div id="menu">
        <a href="../../index.html">Strona Główna</a> |
        <a href="../../container/projekty/index.html">Gry/Prodżekts</a> |
        <a href="../../container/galeria/index.html">Galeria</a> |
        <a href="../../container/kontakt/index.html">Kontakt</a> |
        <a href="../../container/swiatynia/index.html">Świątynia</a> |
        <a id="new" href="#">Księga wpisów</a>
    </div>

    <div id="logan">
        <p id="czyzal">Status...</p>
        <a id="profil" href="../../edytuj.html">Mój profil</a>
    </div>
    <div id="profreg">
        <a id="register" href="../../register.html">
            <img src="../../assets/icons/rejestruj.png" height="13" width="12" alt="*">
            Dołącz do Imperium
        </a>
        <a id="loginlink" href="../../login.html">
            Zaloguj się
            <img style="height:12px; width:12px; vertical-align:middle; margin-right:4px;" src="../../assets/icons/login.png">
        </a>
    </div><br>

    <hr><br>
<div id="main">
    <div id="content" style="max-width: 600px; margin: auto;">
        <h2>Księga Wpisów</h2>
        <p id="regulamin-tekst">
            Witaj na mini forum na mojej stronie. Nie biorę odpowiedzialności za brak zdolności do rozróżniania dobra i zła... Pozdrawiam :)
        </p>

        <form id="guestbook-form">
            <div style="background: #ffffcc; padding: 5px; border: 1px solid #ccc; margin-bottom: 10px;">
                <input type="checkbox" id="akceptuje-szponta" required>
                <label for="akceptuje-szponta" style="font-size: 11px;">
                    Przeczytałem, zrozumiałem i obiecuję godnie reprezentować Imperium
                </label>
            </div>

            <label style="font-weight: bold;">Kim jestem?</label><br>
            <input type="text" id="guest-name" name="name" disabled placeholder="Zaloguj się by pisać"><br><br>
            
            <label style="font-weight: bold;">Napisz na ściane</label><br>
            <textarea id="guest-content" maxlength="500" rows="4" cols="50" 
                    placeholder="Treść wpisu (max 500 znaków)" required ></textarea><br><br>
            
            <button type="submit" id="submit-btn" class="button" disabled>Dodaj wpis</button>
        </form>

        <hr>
        <div id="entries-list">Ładowanie wpisów...</div>
</div>
        <div id="sidebar">
            <div class="infobox" style="border: 2px solid red; background: #ffe6e6; min-height: auto;">
                <h3 style="color: red; margin-top: 0; font-size: 14px;">Centrum Naprawcze</h3>
                <p style="font-size: 10px; margin-bottom: 8px;">Strona wyglada jak rozjechane gówno?<br> Nie masz nowej aktualizacji?<br> Kliknij to aby poprawic!!</p>
                <button onclick="wyczyscDlaImperium()" style="width: 100%; background: red; color: white; border: 1px solid black; cursor: pointer; font-weight: bold; padding: 8px;">
                    AKTUALIZUJ STRONE
                </button>
                <script>
    document.addEventListener('click', function() {
        const audio = new Audio('../../assets/witaj.mp3');
        audio.play();
    }, { once: true });

    function wyczyscDlaImperium() {
        localStorage.clear();
        const cookies = document.cookie.split(";");
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i];
            const eqPos = cookie.indexOf("=");
            const name = eqPos > -1 ? cookie.substr(0, eqPos) : cookie;
            document.cookie = name + "=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/";
        }
        location.reload(true);
    }
</script>
            </div>
    <script>
    const checkbox = document.getElementById('akceptuje-szponta');
    const submitBtn = document.getElementById('submit-btn');

    if (localStorage.getItem('regulamin_zaakceptowany') === 'true') {
        checkbox.checked = true;
        submitBtn.disabled = false;
    }

    checkbox.addEventListener('change', function() {
        if (this.checked) {
            submitBtn.disabled = false;
            localStorage.setItem('regulamin_zaakceptowany', 'true');
        } else {
            submitBtn.disabled = true;
            localStorage.removeItem('regulamin_zaakceptowany');
        }
    });
</script><br>
</div>

<script type="module">
import { auth, db } from '../../assets/firebase.js';
import { collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";
import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";

function formatDate(timestamp) {
    if (!timestamp) return "Teraz";
    const date = timestamp.toDate();
    return date.toLocaleString("pl-PL", {
        day: "2-digit",
        month: "2-digit",
        year: "numeric",
        hour: "2-digit",
        minute: "2-digit"
    });
}

function sanitizeHtml(str) {
    const temp = document.createElement('div');
    temp.innerHTML = str;
    const allowedTags = ['A','IMG','P', 'BUTTON'];

    function clean(node) {
        if (node.nodeType === 1) {
            if (!allowedTags.includes(node.tagName)) {
                const text = document.createTextNode(node.textContent);
                node.parentNode.replaceChild(text, node);
            } else {
                if (node.tagName === 'A') {
                    const href = node.getAttribute('href');
                    node.setAttribute('href', href || '#');
                    node.setAttribute('target','_blank');
                }
                if (node.tagName === 'IMG') {
                    const src = node.getAttribute('src');
                    node.setAttribute('src', src || '');
                    node.setAttribute('alt','');
                    node.setAttribute('loading','lazy');
                    node.removeAttribute('onerror');
                    node.style.maxWidth = '300px';
                    node.style.maxHeight = '200px';
                    node.style.width = 'auto';
                    node.style.height = 'auto';
                }
            }
        }
        Array.from(node.childNodes).forEach(clean);
    }

    Array.from(temp.childNodes).forEach(clean);
    return temp.innerHTML;
}

// renderowanie wpisu
function renderEntry(id, d) {
    const user = auth.currentUser;
    const canEdit = user && (user.uid === d.uid || user.isAdmin);

    return `
    <div class="entry" style="border-bottom:1px dotted #888; margin-bottom:10px; padding:5px;">
        <strong>${d.name}</strong>
        <small style="color:#666">(${formatDate(d.createdAt)})</small>
        <p style="margin-top:5px;">${sanitizeHtml(d.content)}</p>
        ${canEdit ? `<button onclick="deleteEntry('${id}')">Usuń</button>` : ""}
    </div>`;
}

// usuwanie wpisu
window.deleteEntry = async (id) => {
    if (!confirm("Usunąć wpis?")) return;
    await deleteDoc(doc(db, "guestbook", id));
};

// ladowanie wpisów
const list = document.getElementById('entries-list');
const q = query(collection(db, "guestbook"), orderBy("createdAt", "desc"));

onSnapshot(q, (snap) => {
    list.innerHTML = "";
    snap.forEach(doc => {
        const d = doc.data();
        list.innerHTML += renderEntry(doc.id, d);
    });
});

// Formularz dodawania wpisu
const form = document.getElementById('guestbook-form');
const nameInput = document.getElementById('guest-name');

form.onsubmit = async (e) => {
    e.preventDefault();
    const user = auth.currentUser;
    if (!user) { alert("Musisz być zalogowany."); return; }

    const content = document.getElementById('guest-content').value.trim();
    if (content.length < 3) return;

    try {
        await addDoc(collection(db, "guestbook"), {
            uid: user.uid,
            name: user.displayName || "Anon",
            content,
            createdAt: serverTimestamp(),
            edited: false
        });
        form.reset();
    } catch (err) {
        console.error(err);
        alert("Błąd podczas dodawania. Sprawdź limity znaków.");
    }
};

// Wyświetlanie nicku zalogowanego użytkownika
onAuthStateChanged(auth, (user) => {
    if (user) {
        nameInput.value = user.displayName || "Anon";
        nameInput.disabled = true;
    } else {
        nameInput.value = "";
        nameInput.placeholder = "Zaloguj się lub zarejestruj!";
        nameInput.disabled = true;
    }
});

// Status logowania w nagłówku
const status = document.getElementById("czyzal");
const link = document.getElementById("loginlink");

onAuthStateChanged(auth, (user) => {
    if (user) {
        status.textContent = "Zalogowany jako: " + user.displayName;
        link.innerHTML = 'Wyloguj <img src="../../assets/icons/logout.png" alt="*" style="height:12px; width:12px; vertical-align:middle; margin-right:4px;">';
        link.href = "../../index.html";
        link.onclick = (e) => { e.preventDefault(); signOut(auth); };
    } else {
        status.textContent = "Nie jesteś zalogowany";
        link.innerHTML = 'Zaloguj się <img style="height:12px; width:12px; vertical-align:middle; margin-right:4px;" src="../../assets/icons/login.png">';
        link.href = "../../login.html";
    }
});
</script>
</div>
</div>

<div class="footer">
    
    Strona stworzona przez obywateli Imperium Lechitów.
    <p style="text-align:center;">
    Odwiedzilo nas: <script type="text/javascript" src="https://counter.websiteout.com/js/21/0/0/0"></script> osob.
</p>

</div>

<script type="module" src="../../assets/firebase.js"></script>
</body>
</html>
